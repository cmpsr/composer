name: Delete Images and Cloud Run service
on: 'delete'

env:
  PROJECT_ID: ${{ secrets.RUN_PROJECT }}
  RUN_REGION: us-central1

jobs:
  delete:
    permissions:
      contents: 'read'
      id-token: 'write'

    if: ${{github.event.ref_type == 'branch' && github.event.ref != 'changeset-release/master'}}
    name: Delete storybook
    runs-on: ubuntu-latest

    steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: ${{ secrets.GCP_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@v1

    # Delete images from gcloud
    - name: Delete images
      run: |-
        gcloud container images list-tags gcr.io/${PROJECT_ID}/storybook-${{ github.event.ref }} \
        --format='get(digest)' \
        --limit=unlimited | xargs -I {arg} gcloud container images delete "gcr.io/${PROJECT_ID}/storybook-${{ github.event.ref }}@{arg}" \
        --force-delete-tags \
        --quiet

    # Delete cloud-run from gcloud
    - name: Delete cloud run services
      run: |-
        gcloud run services delete "storybook-${{ github.event.ref }}" \
        --region $RUN_REGION \
        --platform "managed" \
        --quiet
